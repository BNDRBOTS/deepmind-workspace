"""\nIntegration tests for secrets management system.\nTests secret_validator, secrets_manager, and generate_secrets CLI.\n"""\nimport os\nimport sys\nimport math\nimport json\nimport subprocess\nfrom unittest.mock import patch, MagicMock\nfrom collections import Counter\n\nimport pytest\n\n\ndef _shannon_entropy(data: str) -> float:\n    \"\"\"Mirror of the validator's entropy calculation for test assertions.\"\"\"\n    if not data:\n        return 0.0\n    length = len(data)\n    freq = Counter(data)\n    return -sum((count / length) * math.log2(count / length) for count in freq.values())\n\n\nclass TestSecretValidator:\n    \"\"\"Tests for startup secret validation.\"\"\"\n\n    def test_rejects_empty_secret_key(self):\n        from deepmind.utils.secret_validator import _check_secret_key\n        errors = _check_secret_key(\"APP_SECRET_KEY\", \"\", required=True)\n        assert len(errors) > 0\n        assert \"not set\" in errors[0]\n\n    def test_rejects_placeholder_value(self):\n        from deepmind.utils.secret_validator import _check_secret_key\n        errors = _check_secret_key(\"APP_SECRET_KEY\", \"changeme\")\n        assert len(errors) > 0\n        assert \"default/placeholder\" in errors[0]\n\n    def test_rejects_short_key(self):\n        from deepmind.utils.secret_validator import _check_secret_key\n        errors = _check_secret_key(\"APP_SECRET_KEY\", \"abc123\")\n        assert len(errors) > 0\n        assert \"too short\" in errors[0]\n\n    def test_rejects_low_entropy_key(self):\n        from deepmind.utils.secret_validator import _check_secret_key\n        errors = _check_secret_key(\"APP_SECRET_KEY\", \"a\" * 48, min_entropy=3.5)\n        assert len(errors) > 0\n        assert \"entropy\" in errors[0].lower()\n\n    def test_accepts_valid_key(self):\n        import secrets\n        from deepmind.utils.secret_validator import _check_secret_key\n        key = secrets.token_urlsafe(64)\n        errors = _check_secret_key(\"APP_SECRET_KEY\", key)\n        assert errors == []\n\n    def test_entropy_of_random_key(self):\n        import secrets\n        key = secrets.token_urlsafe(64)\n        entropy = _shannon_entropy(key)\n        assert entropy > 5.0\n\n    def test_production_mode_raises_system_exit(self):\n        \"\"\"In production mode, bad secrets must raise SystemExit.\"\"\"\n        from deepmind.utils.secret_validator import validate_secrets_on_startup\n        from dataclasses import dataclass\n\n        @dataclass\n        class MockApp:\n            secret_key: str = \"\"\n            env: str = \"production\"\n\n        @dataclass\n        class MockDeepSeek:\n            api_key: str = \"\"\n\n        @dataclass\n        class MockOpenAI:\n            api_key: str = \"\"\n\n        @dataclass\n        class MockImageGen:\n            api_key: str = \"\"\n\n        @dataclass\n        class MockGitHub:\n            enabled: bool = False\n            token: str = \"\"\n\n        @dataclass\n        class MockConnectors:\n            github: MockGitHub = None\n\n        @dataclass\n        class MockConfig:\n            app: MockApp = None\n            deepseek: MockDeepSeek = None\n            openai: MockOpenAI = None\n            image_generation: MockImageGen = None\n            connectors: MockConnectors = None\n\n        config = MockConfig(\n            app=MockApp(secret_key=\"\", env=\"production\"),\n            deepseek=MockDeepSeek(),\n            openai=MockOpenAI(),\n            image_generation=MockImageGen(),\n            connectors=MockConnectors(github=MockGitHub()),\n        )\n\n        with pytest.raises(SystemExit):\n            validate_secrets_on_startup(config)\n\n    def test_development_mode_warns_but_continues(self):\n        \"\"\"In development mode, bad secrets warn but do not crash.\"\"\"\n        from deepmind.utils.secret_validator import validate_secrets_on_startup\n        from dataclasses import dataclass\n\n        @dataclass\n        class MockApp:\n            secret_key: str = \"\"\n            env: str = \"development\"\n\n        @dataclass\n        class MockDeepSeek:\n            api_key: str = \"\"\n\n        @dataclass\n        class MockOpenAI:\n            api_key: str = \"\"\n\n        @dataclass\n        class MockImageGen:\n            api_key: str = \"\"\n\n        @dataclass\n        class MockGitHub:\n            enabled: bool = False\n            token: str = \"\"\n\n        @dataclass\n        class MockConnectors:\n            github: MockGitHub = None\n\n        @dataclass\n        class MockConfig:\n            app: MockApp = None\n            deepseek: MockDeepSeek = None\n            openai: MockOpenAI = None\n            image_generation: MockImageGen = None\n            connectors: MockConnectors = None\n\n        config = MockConfig(\n            app=MockApp(secret_key=\"\", env=\"development\"),\n            deepseek=MockDeepSeek(),\n            openai=MockOpenAI(),\n            image_generation=MockImageGen(),\n            connectors=MockConnectors(github=MockGitHub()),\n        )\n\n        # Should NOT raise â€” dev mode is non-fatal\n        validate_secrets_on_startup(config)\n\n\nclass TestSecretsManager:\n    \"\"\"Tests for secrets_manager with mock Vault backend.\"\"\"\n\n    def test_environment_provider_reads_env(self):\n        \"\"\"Environment provider resolves from env vars.\"\"\"\n        with patch.dict(os.environ, {\"TEST_SECRET_XYZ\": \"hunter2\"}):\n            from deepmind.services.secrets_manager import EnvironmentSecretsProvider\n            with patch(\"deepmind.services.secrets_manager.get_config\") as mock_cfg:\n                mock_cfg.return_value = MagicMock()\n                provider = EnvironmentSecretsProvider()\n                assert provider.get(\"TEST_SECRET_XYZ\") == \"hunter2\"\n\n    def test_vault_provider_mock(self):\n        \"\"\"Mock Vault integration: verify services retrieve secrets via manager.\"\"\"\n        with patch(\"deepmind.services.secrets_manager.get_config\") as mock_cfg:\n            mock_secrets_cfg = MagicMock()\n            mock_secrets_cfg.vault_url = \"https://vault.test:8200\"\n            mock_secrets_cfg.vault_mount = \"secret\"\n            mock_secrets_cfg.vault_path = \"deepmind\"\n            mock_cfg.return_value.secrets = mock_secrets_cfg\n\n            from deepmind.services.secrets_manager import VaultSecretsProvider\n\n            provider = VaultSecretsProvider()\n\n            mock_hvac_client = MagicMock()\n            mock_hvac_client.is_authenticated.return_value = True\n            mock_hvac_client.secrets.kv.v2.read_secret_version.return_value = {\n                \"data\": {\n                    \"data\": {\n                        \"DEEPSEEK_API_KEY\": \"sk-vault-deep-001\",\n                        \"OPENAI_API_KEY\": \"sk-vault-oai-002\",\n                        \"JWT_SECRET_KEY\": \"vault-jwt-secret-\" + \"x\" * 64,\n                    }\n                }\n            }\n            provider._client = mock_hvac_client\n\n            assert provider.get(\"DEEPSEEK_API_KEY\") == \"sk-vault-deep-001\"\n            assert provider.get(\"OPENAI_API_KEY\") == \"sk-vault-oai-002\"\n            assert provider.get(\"JWT_SECRET_KEY\").startswith(\"vault-jwt-secret-\")\n            assert provider.exists(\"DEEPSEEK_API_KEY\")\n            assert not provider.exists(\"NONEXISTENT_KEY\")\n\n\nclass TestGenerateSecrets:\n    \"\"\"Tests for scripts/generate_secrets.py CLI.\"\"\"\n\n    def test_generate_secrets_runs(self):\n        \"\"\"CLI outputs keys to stderr without error.\"\"\"\n        result = subprocess.run(\n            [sys.executable, \"scripts/generate_secrets.py\", \"--json\"],\n            capture_output=True,\n            text=True,\n        )\n        assert result.returncode == 0\n        data = json.loads(result.stderr)\n        assert \"APP_SECRET_KEY\" in data\n        assert \"JWT_SECRET_KEY\" in data\n        assert \"JWT_REFRESH_SECRET_KEY\" in data\n        for key, value in data.items():\n            assert len(value) >= 32, f\"{key} too short: {len(value)}\"\n\n    def test_generate_secrets_env_format(self):\n        \"\"\"CLI --env flag outputs valid .env format.\"\"\"\n        result = subprocess.run(\n            [sys.executable, \"scripts/generate_secrets.py\", \"--env\"],\n            capture_output=True,\n            text=True,\n        )\n        assert result.returncode == 0\n        lines = [l for l in result.stderr.strip().split(\"\\n\") if not l.startswith(\"#\")]\n        for line in lines:\n            assert \"=\" in line, f\"Invalid .env line: {line}\"\n            key, value = line.split(\"=\", 1)\n            assert len(value) >= 32\n