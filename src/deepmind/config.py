"""\nConfiguration loader for DeepMind Workspace.\nLoads from config/app.yaml with environment variable interpolation.\nPerforms startup secret validation via secret_validator.\n"""\nimport os\nimport re\nfrom pathlib import Path\nfrom dataclasses import dataclass, field\nfrom typing import Optional, Any\nimport yaml\nimport structlog\n\nlog = structlog.get_logger()\n\n\n@dataclass\nclass AppConfig:\n    name: str = \"DeepMind Workspace\"\n    version: str = \"1.0.0\"\n    host: str = \"0.0.0.0\"\n    port: int = 8080\n    secret_key: str = \"\"\n    env: str = \"production\"\n    log_level: str = \"INFO\"\n\n\n@dataclass\nclass AuthConfig:\n    jwt_access_expiry_minutes: int = 15\n    jwt_refresh_expiry_days: int = 7\n    jwt_algorithm: str = \"HS256\"\n    bcrypt_rounds: int = 12\n    session_cookie_secure: bool = True\n    session_cookie_httponly: bool = True\n    session_cookie_samesite: str = \"lax\"\n    account_lockout_threshold: int = 5\n    account_lockout_duration_minutes: int = 15\n    password_min_length: int = 8\n    require_email_verification: bool = False\n\n\n@dataclass\nclass SecretsConfig:\n    \"\"\"Configuration for secrets management provider.\"\"\"\n    provider: str = \"environment\"\n    vault_url: str = \"\"\n    vault_mount: str = \"secret\"\n    vault_path: str = \"deepmind\"\n    aws_region: str = \"us-east-1\"\n    aws_secret_name: str = \"deepmind/secrets\"\n    local_encrypted_path: str = \"data/.secrets.enc\"\n\n\n@dataclass\nclass DeepSeekConfig:\n    api_key: str = \"\"\n    base_url: str = \"https://api.deepseek.com/v1\"\n    chat_model: str = \"deepseek-chat\"\n    reasoning_model: str = \"deepseek-reasoner\"\n    max_tokens: int = 8192\n    temperature: float = 0.7\n    top_p: float = 0.95\n    stream: bool = True\n    timeout_seconds: int = 120\n    retry_attempts: int = 3\n    retry_backoff: float = 2.0\n\n\n@dataclass\nclass OpenAIConfig:\n    api_key: str = \"\"\n    base_url: str = \"https://api.openai.com/v1\"\n    model: str = \"gpt-4o\"\n    max_tokens: int = 4096\n    temperature: float = 0.7\n    top_p: float = 0.95\n    stream: bool = True\n    timeout_seconds: int = 120\n    retry_attempts: int = 3\n    retry_backoff: float = 2.0\n\n\n@dataclass\nclass CodeExecutionConfig:\n    enabled: bool = True\n    timeout_seconds: int = 300\n    max_output_bytes: int = 10485760\n    max_recursion_depth: int = 1000\n    allow_network: bool = False\n    restricted_python: bool = True\n\n\n@dataclass\nclass ImageModelConfig:\n    name: str = \"\"\n    max_width: int = 1024\n    max_height: int = 1024\n    steps: int = 20\n    cost_per_image: float = 0.01\n    unfiltered: bool = False\n\n\n@dataclass\nclass ImageGenerationConfig:\n    enabled: bool = True\n    provider: str = \"together\"\n    api_key: str = \"\"\n    base_url: str = \"https://api.together.xyz/v1\"\n    models: dict[str, ImageModelConfig] = field(default_factory=dict)\n    default_model: str = \"pro\"\n    default_width: int = 1024\n    default_height: int = 1024\n    timeout_seconds: int = 180\n    retry_attempts: int = 2\n    save_to_disk: bool = True\n    output_dir: str = \"/data/generated_images\"\n    inline_display: bool = True\n\n\n@dataclass\nclass DatabaseConfig:\n    sqlite_path: str = \"./data/conversations.db\"\n    chromadb_path: str = \"./data/chromadb\"\n    wal_mode: bool = True\n    busy_timeout_ms: int = 10000\n\n\n@dataclass\nclass ContextConfig:\n    max_tokens: int = 128000\n    summary_trigger_tokens: int = 96000\n    recent_messages_keep: int = 20\n    summarization_model: str = \"deepseek-chat\"\n    summarization_max_tokens: int = 2048\n    overlap_messages: int = 3\n\n\n@dataclass\nclass EmbeddingsConfig:\n    model: str = \"all-MiniLM-L6-v2\"\n    dimension: int = 384\n    chunk_size: int = 1000\n    chunk_overlap: int = 200\n    batch_size: int = 64\n    relevance_threshold: float = 0.35\n    max_results: int = 8\n\n\n@dataclass\nclass GitHubConnectorConfig:\n    enabled: bool = True\n    token: str = \"\"\n    default_org: str = \"\"\n    sync_interval_minutes: int = 30\n    file_extensions: list[str] = field(default_factory=list)\n    max_file_size_kb: int = 500\n\n\n@dataclass\nclass DropboxConnectorConfig:\n    enabled: bool = False\n    app_key: str = \"\"\n    app_secret: str = \"\"\n    refresh_token: str = \"\"\n    sync_folder: str = \"/DeepMindWorkspace\"\n    sync_interval_minutes: int = 15\n\n\n@dataclass\nclass GoogleDriveDevScaffoldConfig:\n    enabled: bool = True\n    search_triggers: list[str] = field(default_factory=list)\n    file_types: list[str] = field(default_factory=list)\n\n\n@dataclass\nclass GoogleDriveConnectorConfig:\n    enabled: bool = False\n    client_id: str = \"\"\n    client_secret: str = \"\"\n    redirect_uri: str = \"http://localhost:8080/api/connectors/google/callback\"\n    scopes: list[str] = field(default_factory=list)\n    sync_interval_minutes: int = 15\n    dev_scaffold: GoogleDriveDevScaffoldConfig = field(default_factory=GoogleDriveDevScaffoldConfig)\n\n\n@dataclass\nclass ConnectorsConfig:\n    github: GitHubConnectorConfig = field(default_factory=GitHubConnectorConfig)\n    dropbox: DropboxConnectorConfig = field(default_factory=DropboxConnectorConfig)\n    google_drive: GoogleDriveConnectorConfig = field(default_factory=GoogleDriveConnectorConfig)\n\n\n@dataclass\nclass CodeControlsConfig:\n    show_timeout_slider: bool = True\n    show_output_limit_slider: bool = True\n    timeout_min: int = 10\n    timeout_max: int = 600\n    output_limit_presets: list[str] = field(default_factory=lambda: [\"1MB\", \"10MB\", \"50MB\", \"100MB\"])\n\n\n@dataclass\nclass ImageControlsConfig:\n    show_model_selector: bool = True\n    show_size_presets: bool = True\n    show_quality_slider: bool = True\n    size_presets: list[str] = field(default_factory=list)\n\n\n@dataclass\nclass UIConfig:\n    theme: str = \"dark\"\n    title: str = \"DeepMind Workspace\"\n    sidebar_width: int = 340\n    message_max_display: int = 200\n    token_warning_percent: int = 80\n    token_critical_percent: int = 95\n    animations: bool = True\n    font_family: str = \"Inter, system-ui, -apple-system, sans-serif\"\n    code_font: str = \"JetBrains Mono, Fira Code, monospace\"\n    code_controls: CodeControlsConfig = field(default_factory=CodeControlsConfig)\n    image_controls: ImageControlsConfig = field(default_factory=ImageControlsConfig)\n\n\n@dataclass\nclass Config:\n    app: AppConfig = field(default_factory=AppConfig)\n    auth: AuthConfig = field(default_factory=AuthConfig)\n    secrets: SecretsConfig = field(default_factory=SecretsConfig)\n    deepseek: DeepSeekConfig = field(default_factory=DeepSeekConfig)\n    openai: OpenAIConfig = field(default_factory=OpenAIConfig)\n    code_execution: CodeExecutionConfig = field(default_factory=CodeExecutionConfig)\n    image_generation: ImageGenerationConfig = field(default_factory=ImageGenerationConfig)\n    database: DatabaseConfig = field(default_factory=DatabaseConfig)\n    context: ContextConfig = field(default_factory=ContextConfig)\n    embeddings: EmbeddingsConfig = field(default_factory=EmbeddingsConfig)\n    connectors: ConnectorsConfig = field(default_factory=ConnectorsConfig)\n    ui: UIConfig = field(default_factory=UIConfig)\n\n\ndef _interpolate_env_vars(value: Any) -> Any:\n    \"\"\"\n    Recursively interpolate environment variables in config values.\n    Supports ${VAR} and ${VAR:default} syntax.\n    \"\"\"\n    if isinstance(value, str):\n        pattern = r'\\$\\{([A-Z_][A-Z0-9_]*)(?::([^}]*))?\\}'\n        \n        def replacer(match):\n            var_name = match.group(1)\n            default_value = match.group(2) if match.group(2) is not None else \"\"\n            return os.environ.get(var_name, default_value)\n        \n        return re.sub(pattern, replacer, value)\n    \n    elif isinstance(value, dict):\n        return {k: _interpolate_env_vars(v) for k, v in value.items()}\n    \n    elif isinstance(value, list):\n        return [_interpolate_env_vars(item) for item in value]\n    \n    return value\n\n\ndef _dict_to_dataclass(data: dict, cls):\n    \"\"\"Convert dict to dataclass, handling nested dataclasses.\"\"\"\n    if data is None:\n        return cls()\n    \n    field_types = {f.name: f.type for f in cls.__dataclass_fields__.values()}\n    kwargs = {}\n    \n    for key, value in data.items():\n        if key not in field_types:\n            continue\n        \n        field_type = field_types[key]\n        \n        if hasattr(field_type, '__dataclass_fields__'):\n            kwargs[key] = _dict_to_dataclass(value, field_type)\n        elif isinstance(value, dict) and hasattr(field_type, '__origin__'):\n            if field_type.__origin__ is dict:\n                args = getattr(field_type, '__args__', (None, None))\n                if len(args) == 2 and hasattr(args[1], '__dataclass_fields__'):\n                    kwargs[key] = {k: _dict_to_dataclass(v, args[1]) for k, v in value.items()}\n                else:\n                    kwargs[key] = value\n            else:\n                kwargs[key] = value\n        else:\n            kwargs[key] = value\n    \n    return cls(**kwargs)\n\n\ndef load_config(config_path: Optional[str] = None) -> Config:\n    \"\"\"\n    Load configuration from YAML file with environment variable interpolation.\n    Performs startup secret validation after loading.\n    \n    Args:\n        config_path: Path to config file (defaults to config/app.yaml)\n    \n    Returns:\n        Parsed Config object\n        \n    Raises:\n        SystemExit: If secret validation fails in production mode\n    \"\"\"\n    if config_path is None:\n        config_path = Path(__file__).parent.parent.parent / \"config\" / \"app.yaml\"\n    else:\n        config_path = Path(config_path)\n    \n    if not config_path.exists():\n        log.warning(\"config_not_found\", path=str(config_path))\n        return Config()\n    \n    with open(config_path, 'r') as f:\n        raw_config = yaml.safe_load(f)\n    \n    interpolated = _interpolate_env_vars(raw_config)\n    config = _dict_to_dataclass(interpolated, Config)\n    \n    log.info(\n        \"config_loaded\",\n        path=str(config_path),\n        env=config.app.env,\n        log_level=config.app.log_level,\n    )\n    \n    # Run startup secret validation\n    from deepmind.utils.secret_validator import validate_secrets_on_startup\n    validate_secrets_on_startup(config)\n    \n    return config\n\n\n_config: Optional[Config] = None\n\n\ndef get_config() -> Config:\n    \"\"\"Get the singleton config instance.\"\"\"\n    global _config\n    if _config is None:\n        _config = load_config()\n    return _config\n\n\ndef reset_config() -> None:\n    \"\"\"Reset singleton (for testing).\"\"\"\n    global _config\n    _config = None\n