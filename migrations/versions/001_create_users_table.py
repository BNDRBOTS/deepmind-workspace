"""\nAlembic Migration: Create users and roles tables.\nRevision ID: 001\nCreate Date: 2026-02-10\n\nSchema aligned 1:1 with src/deepmind/models/user.py.\nAll IDs are String(36) UUIDs. All timestamps are timezone-aware.\n"""\nfrom alembic import op\nimport sqlalchemy as sa\n\n# revision identifiers\nrevision = "001"\ndown_revision = None\nbranch_labels = None\ndepends_on = None\n\n\ndef upgrade() -> None:\n    \"\"\"Create roles, users, and user_roles tables with seed data.\"\"\"\n\n    # ── Roles ──────────────────────────────────────────────────\n    op.create_table(\n        "roles",\n        sa.Column("id", sa.String(36), nullable=False),\n        sa.Column("name", sa.String(50), nullable=False),\n        sa.Column("description", sa.String(255), nullable=True),\n        sa.Column("can_execute_code", sa.Boolean(), nullable=False, server_default="0"),\n        sa.Column("can_generate_images", sa.Boolean(), nullable=False, server_default="0"),\n        sa.Column("can_manage_users", sa.Boolean(), nullable=False, server_default="0"),\n        sa.Column("can_access_all_conversations", sa.Boolean(), nullable=False, server_default="0"),\n        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False, server_default=sa.text("CURRENT_TIMESTAMP")),\n        sa.PrimaryKeyConstraint("id"),\n        sa.UniqueConstraint("name"),\n    )\n    op.create_index(op.f("ix_roles_name"), "roles", ["name"], unique=True)\n\n    # ── Users ──────────────────────────────────────────────────\n    op.create_table(\n        "users",\n        sa.Column("id", sa.String(36), nullable=False),\n        sa.Column("username", sa.String(50), nullable=False),\n        sa.Column("email", sa.String(255), nullable=False),\n        sa.Column("password_hash", sa.String(255), nullable=False),\n        sa.Column("full_name", sa.String(255), nullable=True),\n        # Status flags\n        sa.Column("is_active", sa.Boolean(), nullable=False, server_default="1"),\n        sa.Column("is_verified", sa.Boolean(), nullable=False, server_default="0"),\n        sa.Column("is_locked", sa.Boolean(), nullable=False, server_default="0"),\n        sa.Column("is_superuser", sa.Boolean(), nullable=False, server_default="0"),\n        # Security tracking\n        sa.Column("failed_login_attempts", sa.Integer(), nullable=False, server_default="0"),\n        sa.Column("last_login_at", sa.DateTime(timezone=True), nullable=True),\n        sa.Column("last_login_ip", sa.String(45), nullable=True),\n        sa.Column("last_failed_login", sa.DateTime(timezone=True), nullable=True),\n        sa.Column("locked_at", sa.DateTime(timezone=True), nullable=True),\n        # Verification and reset\n        sa.Column("verification_token", sa.String(255), nullable=True),\n        sa.Column("verified_at", sa.DateTime(timezone=True), nullable=True),\n        sa.Column("reset_token", sa.String(255), nullable=True),\n        sa.Column("reset_token_expires", sa.DateTime(timezone=True), nullable=True),\n        # Timestamps\n        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False, server_default=sa.text("CURRENT_TIMESTAMP")),\n        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False, server_default=sa.text("CURRENT_TIMESTAMP")),\n        sa.PrimaryKeyConstraint("id"),\n        sa.UniqueConstraint("username"),\n        sa.UniqueConstraint("email"),\n    )\n    op.create_index(op.f("ix_users_username"), "users", ["username"], unique=True)\n    op.create_index(op.f("ix_users_email"), "users", ["email"], unique=True)\n\n    # ── User-Role Association ──────────────────────────────────\n    op.create_table(\n        "user_roles",\n        sa.Column("user_id", sa.String(36), nullable=False),\n        sa.Column("role_id", sa.String(36), nullable=False),\n        sa.ForeignKeyConstraint(["role_id"], ["roles.id"], ondelete="CASCADE"),\n        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="CASCADE"),\n        sa.PrimaryKeyConstraint("user_id", "role_id"),\n    )\n\n    # ── Seed Default Roles ─────────────────────────────────────\n    op.execute(\n        \"\"\"\n        INSERT INTO roles (id, name, description, can_execute_code, can_generate_images, can_manage_users, can_access_all_conversations)\n        VALUES\n        ('role_admin', 'admin', 'Full system access', 1, 1, 1, 1),\n        ('role_user', 'user', 'Standard user with code and image access', 1, 1, 0, 0),\n        ('role_readonly', 'readonly', 'Read-only access to own conversations', 0, 0, 0, 0)\n        \"\"\"\n    )\n\n\ndef downgrade() -> None:\n    \"\"\"Drop all auth tables in correct FK order.\"\"\"\n    op.drop_table("user_roles")\n    op.drop_index(op.f("ix_users_email"), table_name="users")\n    op.drop_index(op.f("ix_users_username"), table_name="users")\n    op.drop_table("users")\n    op.drop_index(op.f("ix_roles_name"), table_name="roles")\n    op.drop_table("roles")\n